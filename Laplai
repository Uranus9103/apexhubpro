--// Action Replay System (Record + Playback + Anti-Die Clone)
-- Đặt script này vào StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LOCAL_PLAYER = Players.LocalPlayer
local playerGui = LOCAL_PLAYER:WaitForChild("PlayerGui")

--======================
-- Config
--======================
local REMOTE_NAME = "ActionRecordEvent"
local TICK_RATE = 0.12
local MAX_RECORD_SECONDS = 120

--======================
-- RemoteEvent (tạo nếu chưa có)
--======================
local remote = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
if not remote then
    remote = Instance.new("RemoteEvent")
    remote.Name = REMOTE_NAME
    remote.Parent = ReplicatedStorage
end

--======================
-- UI Tạo Menu
--======================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ActionReplayUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 150, 0, 200)
frame.Position = UDim2.new(1, -160, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Parent = ScreenGui
frame.Active = true
frame.Draggable = true

local UIList = Instance.new("UIListLayout")
UIList.FillDirection = Enum.FillDirection.Vertical
UIList.Padding = UDim.new(0, 5)
UIList.Parent = frame

local function createBtn(text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -10, 0, 40)
    btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Text = text
    btn.Parent = frame
    return btn
end

local recordBtn = createBtn("▶ Start Record")
local playBtn   = createBtn("⏯ Play")
local clearBtn  = createBtn("✖ Clear")

--======================
-- Record system
--======================
local recording = false
local frames = {}
local recordStartTime = 0
local recordConn
local activeToolConns = {}

local function captureFrame()
    local char = LOCAL_PLAYER.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local frame = {
        time = tick() - recordStartTime,
        cframe = hrp.CFrame,
        toolActivatedName = nil
    }
    table.insert(frames, frame)
end

local function watchTools()
    for _, c in pairs(activeToolConns) do
        if c.Disconnect then c:Disconnect() end
    end
    activeToolConns = {}

    local char = LOCAL_PLAYER.Character
    if not char then return end

    local function bindTool(tool)
        if not tool:IsA("Tool") then return end
        local conn = tool.Activated:Connect(function()
            if #frames > 0 then
                frames[#frames].toolActivatedName = tool.Name
            end
        end)
        table.insert(activeToolConns, conn)
    end

    for _, t in ipairs(char:GetChildren()) do
        if t:IsA("Tool") then bindTool(t) end
    end

    char.ChildAdded:Connect(function(t)
        if t:IsA("Tool") then bindTool(t) end
    end)
end

local function startRecording()
    if recording then return end
    recording = true
    frames = {}
    recordStartTime = tick()
    watchTools()
    recordBtn.Text = "■ Stop Record"

    recordConn = RunService.Heartbeat:Connect(function()
        if not recording then return end
        if tick() - recordStartTime > MAX_RECORD_SECONDS then
            stopRecordingAndSend()
            return
        end
        if #frames == 0 or (tick() - recordStartTime - frames[#frames].time) >= TICK_RATE then
            captureFrame()
        end
    end)
end

function stopRecordingAndSend()
    if not recording then return end
    recording = false
    if recordConn then recordConn:Disconnect() recordConn = nil end
    for _, c in pairs(activeToolConns) do
        if c.Disconnect then c:Disconnect() end
    end
    activeToolConns = {}
    recordBtn.Text = "▶ Start Record"

    remote:FireServer({action = "save", data = {frames = frames, tickRate = TICK_RATE}})
end

--======================
-- Playback system (Server sẽ clone + anti-die)
--======================
local function requestPlay()
    remote:FireServer({action = "play"})
end
local function requestClear()
    remote:FireServer({action = "clear"})
end

--======================
-- Button events
--======================
recordBtn.MouseButton1Click:Connect(function()
    if not recording then
        startRecording()
    else
        stopRecordingAndSend()
    end
end)

playBtn.MouseButton1Click:Connect(function()
    requestPlay()
end)

clearBtn.MouseButton1Click:Connect(function()
    requestClear()
end)

--======================
-- Server handler (chạy trên client nhận thông báo)
--======================
remote.OnClientEvent:Connect(function(msg)
    if type(msg) == "table" and msg.result then
        warn("Server:", msg.result)
    end
end)

print("✅ ActionReplay loaded: dùng nút để Record / Play / Clear")
