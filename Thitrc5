local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- GUI chính
local gui = Instance.new("ScreenGui")
gui.Name = "BaseESP"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- Nút bật/tắt
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 120, 0, 40)
toggleButton.Position = UDim2.new(0, 10, 0, 10) -- góc trên trái
toggleButton.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Text = "Bật ESP"
toggleButton.Parent = gui

-- Biến trạng thái
local espEnabled = false
local espLabels = {}

-- Hàm tạo label ESP
local function createESP(obj)
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(0,200,0,20)
	label.BackgroundTransparency = 1
	label.TextColor3 = Color3.fromRGB(0,255,0)
	label.TextStrokeTransparency = 0.3
	label.Font = Enum.Font.SourceSansBold
	label.TextScaled = true
	label.Text = "[BASE] " .. obj.Name
	label.Visible = false
	label.Parent = gui
	espLabels[obj] = label
end

-- Tạo ESP cho các Base hiện có
for _,obj in pairs(workspace:GetChildren()) do
	if obj:IsA("Model") or obj:IsA("Part") then
		if string.find(obj.Name:lower(), "base") then
			createESP(obj)
		end
	end
end

-- Nếu có Base mới spawn
workspace.ChildAdded:Connect(function(obj)
	if obj:IsA("Model") or obj:IsA("Part") then
		if string.find(obj.Name:lower(), "base") then
			createESP(obj)
		end
	end
end)

-- Cập nhật ESP liên tục
RunService.RenderStepped:Connect(function()
	if not espEnabled then
		for _,label in pairs(espLabels) do
			label.Visible = false
		end
		return
	end

	for obj,label in pairs(espLabels) do
		local pos = nil
		if obj:IsA("Part") then
			pos = obj.Position
		elseif obj:IsA("Model") then
			if obj.PrimaryPart then
				pos = obj.PrimaryPart.Position
			else
				local firstPart = obj:FindFirstChildWhichIsA("BasePart")
				if firstPart then
					pos = firstPart.Position
				end
			end
		end

		if pos then
			local vector, onScreen = camera:WorldToViewportPoint(pos)
			if onScreen then
				label.Position = UDim2.new(0, vector.X - 100, 0, vector.Y - 10)
				local distance = 0
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
					distance = (player.Character.HumanoidRootPart.Position - pos).Magnitude
				end
				label.Text = string.format("[BASE] %s (%.0f)", obj.Name, distance)
				label.Visible = true
			else
				label.Visible = false
			end
		else
			label.Visible = false
		end
	end
end)

-- Sự kiện nút bật/tắt
toggleButton.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	if espEnabled then
		toggleButton.Text = "Tắt ESP"
	else
		toggleButton.Text = "Bật ESP"
	end
end)
