--// TeleportHomeAllInOne.lua
-- ƒê·∫∑t file n√†y trong StarterPlayerScripts

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local REMOTE_NAME = "TeleportHomeRemote"

-- N·∫øu ƒëang ch·∫°y ·ªü client
if RunService:IsClient() then
	-- T·∫°o GUI
	local player = Players.LocalPlayer
	local gui = Instance.new("ScreenGui")
	gui.Name = "TeleportHomeGui"
	gui.ResetOnSpawn = false
	gui.Parent = player:WaitForChild("PlayerGui")

	local button = Instance.new("TextButton")
	button.Name = "HomeButton"
	button.Size = UDim2.new(0, 150, 0, 50)
	button.Position = UDim2.new(0.5, -75, 0.8, 0)
	button.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
	button.Text = "üè† V·ªÅ Nh√†"
	button.Font = Enum.Font.SourceSansBold
	button.TextSize = 22
	button.TextColor3 = Color3.new(1, 1, 1)
	button.Parent = gui

	-- L·∫•y RemoteEvent
	local TeleportRemote = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
	if not TeleportRemote then
		TeleportRemote = Instance.new("RemoteEvent")
		TeleportRemote.Name = REMOTE_NAME
		TeleportRemote.Parent = ReplicatedStorage
	end

	-- S·ª± ki·ªán click
	button.MouseButton1Click:Connect(function()
		TeleportRemote:FireServer()
	end)
end

-- N·∫øu ƒëang ch·∫°y ·ªü server
if RunService:IsServer() then
	local TeleportRemote = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
	if not TeleportRemote then
		TeleportRemote = Instance.new("RemoteEvent")
		TeleportRemote.Name = REMOTE_NAME
		TeleportRemote.Parent = ReplicatedStorage
	end

	local lastUse = {}
	local INVULN_DURATION = 5
	local FREEZE_DURATION = 0.15
	local COOLDOWN = 3

	local function getHomeCFrame()
		local homePart = workspace:FindFirstChild("HomeSpawn")
		if homePart and homePart:IsA("BasePart") then
			return homePart.CFrame
		end
		for _, inst in ipairs(workspace:GetChildren()) do
			if inst:IsA("SpawnLocation") then
				return inst.CFrame
			end
		end
		return CFrame.new(0, 10, 0)
	end

	local function safeTeleport(player)
		if not player or not player.Character then return end
		local char = player.Character
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if not humanoid or not hrp then return end

		-- Ch·ªëng spam
		if lastUse[player] and (time() - lastUse[player]) < COOLDOWN then
			return
		end
		lastUse[player] = time()

		-- M·ª•c ti√™u
		local homeCF = getHomeCFrame()
		local up = Vector3.new(0, (humanoid.HipHeight or 2) + 3, 0)
		local targetCF = homeCF + up

		-- ForceField b·∫£o v·ªá
		local ff = Instance.new("ForceField")
		ff.Visible = false
		ff.Parent = char

		-- Kho√° v·∫≠t l√Ω ng·∫Øn
		local oldStand = humanoid.PlatformStand
		humanoid.PlatformStand = true
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero
		hrp.Anchored = true

		if char.PrimaryPart ~= hrp then
			char.PrimaryPart = hrp
		end
		char:PivotTo(targetCF)

		task.delay(FREEZE_DURATION, function()
			if hrp and hrp.Parent == char then
				hrp.Anchored = false
			end
			if humanoid and humanoid.Parent == char then
				humanoid.PlatformStand = oldStand
			end
		end)

		task.delay(0.2, function()
			if hrp and hrp.Parent == char then
				hrp.AssemblyLinearVelocity = Vector3.zero
				hrp.AssemblyAngularVelocity = Vector3.zero
			end
		end)

		task.delay(INVULN_DURATION, function()
			if ff then ff:Destroy() end
		end)
	end

	TeleportRemote.OnServerEvent:Connect(function(player)
		local char = player.Character
		if not char then return end
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		if not humanoid or humanoid.Health <= 0 then return end
		safeTeleport(player)
	end)
end
