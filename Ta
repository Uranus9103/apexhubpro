--// TeleportHomeAllInOne.lua
-- ƒê·∫∑t trong StarterPlayerScripts (GitHub load v√†o c≈©ng ch·∫°y)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local REMOTE_NAME = "TeleportHomeRemote"

-- T·∫°o RemoteEvent (chung)
local TeleportRemote = ReplicatedStorage:FindFirstChild(REMOTE_NAME)
if not TeleportRemote then
	TeleportRemote = Instance.new("RemoteEvent")
	TeleportRemote.Name = REMOTE_NAME
	TeleportRemote.Parent = ReplicatedStorage
end

-- ================= CLIENT =================
if RunService:IsClient() then
	local player = Players.LocalPlayer

	-- GUI
	local gui = Instance.new("ScreenGui")
	gui.Name = "TeleportHomeGui"
	gui.ResetOnSpawn = false
	gui.Parent = player:WaitForChild("PlayerGui")

	local button = Instance.new("TextButton")
	button.Size = UDim2.new(0,150,0,50)
	button.Position = UDim2.new(0.5,-75,0.8,0)
	button.BackgroundColor3 = Color3.fromRGB(0,170,255)
	button.Text = "üè† V·ªÅ Nh√†"
	button.Font = Enum.Font.SourceSansBold
	button.TextSize = 22
	button.TextColor3 = Color3.new(1,1,1)
	button.Parent = gui

	-- Khi b·∫•m n√∫t th√¨ g·ª≠i y√™u c·∫ßu v·ªÅ server
	button.MouseButton1Click:Connect(function()
		TeleportRemote:FireServer()
	end)
end

-- ================= SERVER =================
if RunService:IsServer() then
	local INVULN_DURATION = 5
	local FREEZE_DURATION = 0.15
	local COOLDOWN = 3
	local lastUse = {}

	local function getHomeCFrame()
		local homePart = workspace:FindFirstChild("HomeSpawn")
		if homePart and homePart:IsA("BasePart") then
			return homePart.CFrame
		end
		return CFrame.new(0,10,0)
	end

	local function safeTeleport(player)
		local char = player.Character
		if not char then return end
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if not humanoid or not hrp then return end

		-- cooldown
		if lastUse[player] and (time() - lastUse[player]) < COOLDOWN then return end
		lastUse[player] = time()

		local targetCF = getHomeCFrame() + Vector3.new(0, (humanoid.HipHeight or 2)+3, 0)

		-- b·∫•t t·ª≠
		local ff = Instance.new("ForceField")
		ff.Visible = false
		ff.Parent = char

		-- kh√≥a v·∫≠t l√Ω ng·∫Øn
		local oldStand = humanoid.PlatformStand
		humanoid.PlatformStand = true
		hrp.Anchored = true
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero

		char:PivotTo(targetCF)

		task.delay(FREEZE_DURATION, function()
			if hrp then hrp.Anchored = false end
			if humanoid then humanoid.PlatformStand = oldStand end
		end)

		task.delay(INVULN_DURATION, function()
			if ff then ff:Destroy() end
		end)
	end

	TeleportRemote.OnServerEvent:Connect(function(player)
		local char = player.Character
		local humanoid = char and char:FindFirstChildOfClass("Humanoid")
		if not humanoid or humanoid.Health <= 0 then return end
		safeTeleport(player)
	end)
end
