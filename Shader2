-- AutoPerfShaderSunset.client.lua
-- Shader hoàng hôn + Nhạc thiên nhiên
-- Đặt trong StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local SoundService = game:GetService("SoundService")
local player = Players.LocalPlayer

--------------------------------------------------------
-- PERF UTILS
--------------------------------------------------------
local PerfUtils = {}
local originalStates = {baseparts={},particleEmitters={},trails={},decals={}}
local function isSafeToModify(obj)
    if not obj then return false end
    if obj:IsDescendantOf(game.Players) then return false end
    return true
end
function PerfUtils.applyLowQuality()
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") and isSafeToModify(part) then
            if not originalStates.baseparts[part] then
                originalStates.baseparts[part]={CastShadow=part.CastShadow}
            end
            part.CastShadow=false
        end
        if part:IsA("ParticleEmitter") and isSafeToModify(part) then
            if not originalStates.particleEmitters[part] then
                originalStates.particleEmitters[part]={Enabled=part.Enabled}
            end
            part.Enabled=false
        end
        if part:IsA("Trail") and isSafeToModify(part) then
            if not originalStates.trails[part] then
                originalStates.trails[part]={Enabled=part.Enabled}
            end
            part.Enabled=false
        end
        if part:IsA("Decal") and isSafeToModify(part) then
            if not originalStates.decals[part] then
                originalStates.decals[part]={Transparency=part.Transparency}
            end
            part.Transparency=math.clamp(part.Transparency+0.2,0,1)
        end
    end
    if not originalStates._lighting then
        originalStates._lighting={
            GlobalShadows=Lighting.GlobalShadows,
            Brightness=Lighting.Brightness
        }
    end
    Lighting.GlobalShadows=false
    Lighting.Brightness=0.5
end
function PerfUtils.restoreQuality()
    for p,s in pairs(originalStates.baseparts) do if p and p.Parent then p.CastShadow=s.CastShadow end end
    for e,s in pairs(originalStates.particleEmitters) do if e and e.Parent then e.Enabled=s.Enabled end end
    for t,s in pairs(originalStates.trails) do if t and t.Parent then t.Enabled=s.Enabled end end
    for d,s in pairs(originalStates.decals) do if d and d.Parent then d.Transparency=s.Transparency end end
    if originalStates._lighting then
        Lighting.GlobalShadows=originalStates._lighting.GlobalShadows
        Lighting.Brightness=originalStates._lighting.Brightness
        originalStates._lighting=nil
    end
    originalStates.baseparts,originalStates.particleEmitters,originalStates.trails,originalStates.decals={},{},{},{}
end

--------------------------------------------------------
-- SHADER HOÀNG HÔN + NHẠC
--------------------------------------------------------
local function setupSunsetEffects()
    -- clear old
    for _,v in ipairs({"APS_Bloom","APS_Color","APS_SunRays","APS_DOF","APS_Blur","APS_Atmos","APS_Sky"}) do
        local old=Lighting:FindFirstChild(v)
        if old then old:Destroy() end
    end

    -- Bloom
    local bloom=Instance.new("BloomEffect",Lighting)
    bloom.Name="APS_Bloom"
    bloom.Intensity=1.2
    bloom.Threshold=0.4
    bloom.Size=30

    -- ColorCorrection (cam ấm)
    local color=Instance.new("ColorCorrectionEffect",Lighting)
    color.Name="APS_Color"
    color.Saturation=0.2
    color.Contrast=0.15
    color.TintColor=Color3.fromRGB(255,180,120) -- cam

    -- SunRays
    local sun=Instance.new("SunRaysEffect",Lighting)
    sun.Name="APS_SunRays"
    sun.Intensity=0.25
    sun.Spread=0.4

    -- Depth of Field
    local dof=Instance.new("DepthOfFieldEffect",Lighting)
    dof.Name="APS_DOF"
    dof.FocusDistance=35
    dof.InFocusRadius=10
    dof.NearIntensity=0.2
    dof.FarIntensity=0.4

    -- Atmosphere (màu trời hoàng hôn)
    local atmo=Instance.new("Atmosphere",Lighting)
    atmo.Name="APS_Atmos"
    atmo.Density=0.35
    atmo.Offset=0.25
    atmo.Color=Color3.fromRGB(255,180,130)
    atmo.Decay=Color3.fromRGB(200,100,50)
    atmo.Glare=0.4
    atmo.Haze=1

    -- Sky (màu hoàng hôn cam)
    local sky=Instance.new("Sky",Lighting)
    sky.Name="APS_Sky"
    sky.SkyboxBk="rbxassetid://151294881"
    sky.SkyboxDn="rbxassetid://151294881"
    sky.SkyboxFt="rbxassetid://151294881"
    sky.SkyboxLf="rbxassetid://151294881"
    sky.SkyboxRt="rbxassetid://151294881"
    sky.SkyboxUp="rbxassetid://151294881"
    sky.SunTextureId="rbxassetid://6196665102"
    sky.MoonTextureId="rbxassetid://6444320592"
    sky.StarCount=1500
end

-- Nhạc thiên nhiên
local function playNatureMusic()
    if SoundService:FindFirstChild("APS_NatureMusic") then
        SoundService.APS_NatureMusic:Play()
        return
    end
    local sound=Instance.new("Sound",SoundService)
    sound.Name="APS_NatureMusic"
    sound.SoundId="rbxassetid://1849758357" -- tiếng suối/thiên nhiên
    sound.Looped=true
    sound.Volume=0.5
    sound:Play()
end
local function stopNatureMusic()
    local s=SoundService:FindFirstChild("APS_NatureMusic")
    if s then s:Stop() end
end

--------------------------------------------------------
-- AUTO PERF
--------------------------------------------------------
local TARGET_FPS,LOW_FPS_THRESHOLD,MEDIUM_FPS_THRESHOLD,CHECK_INTERVAL=60,30,45,4
local smoothedFPS=TARGET_FPS
local lastCheck=0
local updating=true

local function setHighQuality() setupSunsetEffects() PerfUtils.restoreQuality() playNatureMusic() end
local function setMediumQuality()
    setupSunsetEffects()
    if Lighting:FindFirstChild("APS_Bloom") then Lighting.APS_Bloom.Intensity=0.7 end
    if Lighting:FindFirstChild("APS_SunRays") then Lighting.APS_SunRays.Intensity=0.1 end
    if Lighting:FindFirstChild("APS_DOF") then Lighting.APS_DOF.Enabled=false end
    PerfUtils.restoreQuality() playNatureMusic()
end
local function setLowQuality()
    stopNatureMusic()
    if Lighting:FindFirstChild("APS_Bloom") then Lighting.APS_Bloom.Enabled=false end
    if Lighting:FindFirstChild("APS_Color") then Lighting.APS_Color.Enabled=false end
    if Lighting:FindFirstChild("APS_SunRays") then Lighting.APS_SunRays.Enabled=false end
    if Lighting:FindFirstChild("APS_DOF") then Lighting.APS_DOF.Enabled=false end
    PerfUtils.applyLowQuality()
end

local function updateFPS(dt)
    local fps=1/math.max(dt,0.0001)
    smoothedFPS=smoothedFPS*0.9+fps*0.1
    lastCheck=lastCheck+dt
    if lastCheck>=CHECK_INTERVAL then
        lastCheck=0
        if smoothedFPS<LOW_FPS_THRESHOLD then setLowQuality()
        elseif smoothedFPS<MEDIUM_FPS_THRESHOLD then setMediumQuality()
        else setHighQuality() end
        StarterGui:SetCore("SendNotification",{Title="AutoPerf",Text="FPS: "..math.floor(smoothedFPS+0.5),Duration=2})
    end
end

local function createToggleGui()
    local gui=Instance.new("ScreenGui",player:WaitForChild("PlayerGui"))
    gui.Name="AutoPerf_GUI"
    gui.ResetOnSpawn=false
    local btn=Instance.new("TextButton",gui)
    btn.Size=UDim2.new(0,140,0,36)
    btn.Position=UDim2.new(1,-150,0,12)
    btn.Text="AutoPerf: ON"
    btn.BackgroundTransparency=0.35
    btn.Font=Enum.Font.SourceSansBold
    btn.TextSize=14
    local state=true
    btn.MouseButton1Click:Connect(function()
        state=not state
        if state then
            btn.Text="AutoPerf: ON"; updating=true; setHighQuality()
        else
            btn.Text="AutoPerf: OFF"; updating=false
            PerfUtils.restoreQuality(); stopNatureMusic()
        end
    end)
end

--------------------------------------------------------
-- INIT
--------------------------------------------------------
setHighQuality()
createToggleGui()
RunService.RenderStepped:Connect(function(dt) if updating then updateFPS(dt) end end)
