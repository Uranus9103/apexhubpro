-- FreezeAllOneFile.lua (LocalScript, StarterPlayerScripts)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Tạo RemoteEvent + BoolValue nếu chưa có (chỉ server mới chạy đoạn này)
if RunService:IsServer() then
    local freezeEvent = Instance.new("RemoteEvent")
    freezeEvent.Name = "FreezeAll"
    freezeEvent.Parent = ReplicatedStorage

    local stateVal = Instance.new("BoolValue")
    stateVal.Name = "GlobalFreeze"
    stateVal.Value = false
    stateVal.Parent = ReplicatedStorage

    local originals = {}

    local function saveOriginal(plr)
        if not plr.Character then return end
        local hum = plr.Character:FindFirstChildOfClass("Humanoid")
        if not hum then return end
        originals[plr.UserId] = {
            WalkSpeed = hum.WalkSpeed,
            Jump = (hum.UseJumpPower and hum.JumpPower) or hum.JumpHeight,
            UseJumpPower = hum.UseJumpPower ~= nil and hum.UseJumpPower or true
        }
    end

    local function restoreOriginal(plr)
        local hum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
        local orig = originals[plr.UserId]
        if hum and orig then
            hum.WalkSpeed = orig.WalkSpeed
            if hum.UseJumpPower ~= nil then
                hum.JumpPower = orig.Jump
            else
                hum.JumpHeight = orig.Jump
            end
        end
    end

    local function applyFreeze(plr, freeze)
        local hum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
        if not hum then return end
        if freeze then
            if not originals[plr.UserId] then saveOriginal(plr) end
            hum.WalkSpeed = 0
            if hum.UseJumpPower ~= nil then
                hum.JumpPower = 0
            else
                hum.JumpHeight = 0
            end
        else
            restoreOriginal(plr)
        end
    end

    local function applyAll(freeze)
        for _, plr in pairs(Players:GetPlayers()) do
            applyFreeze(plr, freeze)
        end
    end

    freezeEvent.OnServerEvent:Connect(function(plr)
        local new = not stateVal.Value
        stateVal.Value = new
        applyAll(new)
    end)

    Players.PlayerAdded:Connect(function(plr)
        plr.CharacterAdded:Connect(function()
            if stateVal.Value then
                task.wait(0.1)
                applyFreeze(plr, true)
            end
        end)
    end)
end

-- =============== CLIENT CODE (GUI) =================
if RunService:IsClient() then
    local freezeEvent = ReplicatedStorage:WaitForChild("FreezeAll")
    local stateVal = ReplicatedStorage:WaitForChild("GlobalFreeze")

    local player = Players.LocalPlayer
    local gui = Instance.new("ScreenGui")
    gui.Name = "FreezeGui"
    gui.ResetOnSpawn = false
    gui.Parent = player:WaitForChild("PlayerGui")

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 180, 0, 50)
    btn.Position = UDim2.new(0.7, 0, 0.8, 0)
    btn.Text = "Đóng băng: TẮT"
    btn.TextScaled = true
    btn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Parent = gui
    btn.Active = true
    btn.Draggable = true

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = btn
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Parent = btn

    local function refresh()
        if stateVal.Value then
            btn.Text = "Đóng băng: BẬT"
            btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        else
            btn.Text = "Đóng băng: TẮT"
            btn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        end
    end
    refresh()
    stateVal:GetPropertyChangedSignal("Value"):Connect(refresh)

    btn.MouseButton1Click:Connect(function()
        freezeEvent:FireServer()
    end)
end
