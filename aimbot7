--// FULL SCRIPT: ESP + Hitbox + AntiAFK + Draggable UI
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--====================================================
-- UI
--====================================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "HelperGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Toggle menu button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0,100,0,40)
ToggleButton.Position = UDim2.new(1,-110,1,-50)
ToggleButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
ToggleButton.TextColor3 = Color3.new(1,1,1)
ToggleButton.Text = "Menu"
ToggleButton.Parent = ScreenGui

-- Main Frame (draggable)
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0,200,0,200)
Frame.Position = UDim2.new(0.5, -100,0.5, -100)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Visible = false
Frame.Parent = ScreenGui

-- Make Frame draggable
local dragging = false
local dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
Frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = Frame
UIListLayout.FillDirection = Enum.FillDirection.Vertical
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Padding = UDim.new(0,5)

-- Toggle menu visibility
ToggleButton.MouseButton1Click:Connect(function()
    Frame.Visible = not Frame.Visible
end)

--====================================================
-- Functions to create UI buttons
--====================================================
local function createToggle(name, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,0,0,40)
    btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Text = "[OFF] " .. name
    btn.Parent = Frame
    local state = false
    btn.MouseButton1Click:Connect(function()
        state = not state
        btn.Text = (state and "[ON] " or "[OFF] ") .. name
        callback(state)
    end)
end

local function createAdjustButton(name, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,0,0,35)
    btn.BackgroundColor3 = Color3.fromRGB(80,80,80)
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Text = name
    btn.Parent = Frame
    btn.MouseButton1Click:Connect(callback)
end

--====================================================
-- ESP
--====================================================
local ESP_Enabled = false
local ESP_Texts = {}
local ESP_Connections = {}

local function clearESP()
    for _, text in pairs(ESP_Texts) do
        if text then
            text:Remove()
        end
    end
    ESP_Texts = {}
    for _, con in pairs(ESP_Connections) do
        con:Disconnect()
    end
    ESP_Connections = {}
end

local function enableESP(state)
    ESP_Enabled = state
    clearESP()
    if not state then return end

    local function esp(p,cr)
        local h = cr:WaitForChild("Humanoid")
        local head = cr:WaitForChild("Head")

        local text = Drawing.new("Text")
        text.Visible = false
        text.Center = true
        text.Outline = false
        text.Font = 3
        text.Size = 16
        text.Color = Color3.new(0,1,1)

        table.insert(ESP_Texts, text)

        local con = RunService.RenderStepped:Connect(function()
            if ESP_Enabled and head and h.Health > 0 then
                local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    text.Position = Vector2.new(pos.X,pos.Y-27)
                    text.Text = "[ "..p.Name.." ]"
                    text.Visible = true
                else
                    text.Visible = false
                end
            else
                text.Visible = false
            end
        end)
        table.insert(ESP_Connections, con)
    end

    local function p_added(p)
        if p ~= LocalPlayer then
            local function charAdded(cr)
                esp(p, cr)
            end
            if p.Character then charAdded(p.Character) end
            p.CharacterAdded:Connect(charAdded)
        end
    end

    for _,p in ipairs(Players:GetPlayers()) do
        p_added(p)
    end
    table.insert(ESP_Connections, Players.PlayerAdded:Connect(p_added))
end

--====================================================
-- Hitbox
--====================================================
local HITBOX_Enabled = false
_G.HitboxSize = 10

local function updateHitbox(v)
    if v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = v.Character.HumanoidRootPart
        hrp.Size = Vector3.new(_G.HitboxSize,_G.HitboxSize,_G.HitboxSize)
        hrp.Transparency = 0.7
        hrp.BrickColor = BrickColor.new("Really red")
        hrp.Material = Enum.Material.Neon
        hrp.CanCollide = false
    end
end

RunService.RenderStepped:Connect(function()
    if HITBOX_Enabled then
        for _,v in ipairs(Players:GetPlayers()) do
            if v ~= LocalPlayer then
                pcall(function()
                    updateHitbox(v)
                end)
            end
        end
    else
        -- Reset hitbox khi tắt
        for _,v in ipairs(Players:GetPlayers()) do
            if v ~= LocalPlayer and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = v.Character.HumanoidRootPart
                hrp.Size = Vector3.new(2,2,1)
                hrp.Transparency = 0
                hrp.Material = Enum.Material.Plastic
                hrp.BrickColor = BrickColor.new("Medium stone grey")
                hrp.CanCollide = true
            end
        end
    end
end)

-- Hitbox adjustment buttons
createAdjustButton("Hitbox +", function()
    _G.HitboxSize = _G.HitboxSize + 2
end)
createAdjustButton("Hitbox -", function()
    _G.HitboxSize = math.max(2,_G.HitboxSize - 2)
end)

--====================================================
-- Anti AFK
--====================================================
Players.LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
end)

--====================================================
-- Gắn nút chức năng
--====================================================
createToggle("ESP", function(state) enableESP(state) end)
createToggle("Hitbox", function(state) HITBOX_Enabled = state end)
