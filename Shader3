-- Shader + Fix Lag Toggle Script
-- Đặt trong StarterPlayer > StarterPlayerScripts

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer

--------------------------------------------------------
-- PERF UTILS
--------------------------------------------------------
local PerfUtils = {}
local originalStates = {baseparts={},particleEmitters={},trails={},decals={}}

local function isSafeToModify(obj)
	if not obj then return false end
	if obj:IsDescendantOf(game.Players) then return false end
	return true
end

function PerfUtils.applyLowQuality()
	for _, part in ipairs(workspace:GetDescendants()) do
		if part:IsA("BasePart") and isSafeToModify(part) then
			if not originalStates.baseparts[part] then
				originalStates.baseparts[part]={CastShadow=part.CastShadow}
			end
			part.CastShadow=false
		end
		if part:IsA("ParticleEmitter") and isSafeToModify(part) then
			if not originalStates.particleEmitters[part] then
				originalStates.particleEmitters[part]={Enabled=part.Enabled}
			end
			part.Enabled=false
		end
		if part:IsA("Trail") and isSafeToModify(part) then
			if not originalStates.trails[part] then
				originalStates.trails[part]={Enabled=part.Enabled}
			end
			part.Enabled=false
		end
		if part:IsA("Decal") and isSafeToModify(part) then
			if not originalStates.decals[part] then
				originalStates.decals[part]={Transparency=part.Transparency}
			end
			part.Transparency=math.clamp(part.Transparency+0.2,0,1)
		end
	end
	if not originalStates._lighting then
		originalStates._lighting={
			GlobalShadows=Lighting.GlobalShadows,
			Brightness=Lighting.Brightness
		}
	end
	Lighting.GlobalShadows=false
	Lighting.Brightness=0.5
end

function PerfUtils.restoreQuality()
	for p,s in pairs(originalStates.baseparts) do if p and p.Parent then p.CastShadow=s.CastShadow end end
	for e,s in pairs(originalStates.particleEmitters) do if e and e.Parent then e.Enabled=s.Enabled end end
	for t,s in pairs(originalStates.trails) do if t and t.Parent then t.Enabled=s.Enabled end end
	for d,s in pairs(originalStates.decals) do if d and d.Parent then d.Transparency=s.Transparency end end
	if originalStates._lighting then
		Lighting.GlobalShadows=originalStates._lighting.GlobalShadows
		Lighting.Brightness=originalStates._lighting.Brightness
		originalStates._lighting=nil
	end
	originalStates.baseparts,originalStates.particleEmitters,originalStates.trails,originalStates.decals={},{},{},{}
end

--------------------------------------------------------
-- SHADER & SKY
--------------------------------------------------------
local function setupEffects()
	for _,v in ipairs({"APS_Bloom","APS_Color","APS_SunRays","APS_DOF","APS_Blur","APS_Sky","APS_Atmos"}) do
		local old=Lighting:FindFirstChild(v)
		if old then old:Destroy() end
	end

	local bloom=Instance.new("BloomEffect",Lighting)
	bloom.Name="APS_Bloom"
	bloom.Intensity=1.5
	bloom.Threshold=0.4
	bloom.Size=35

	local color=Instance.new("ColorCorrectionEffect",Lighting)
	color.Name="APS_Color"
	color.Saturation=0.2
	color.Contrast=0.1
	color.TintColor=Color3.fromRGB(255,244,230)

	local sun=Instance.new("SunRaysEffect",Lighting)
	sun.Name="APS_SunRays"
	sun.Intensity=0.2
	sun.Spread=0.3

	local dof=Instance.new("DepthOfFieldEffect",Lighting)
	dof.Name="APS_DOF"
	dof.FocusDistance=40
	dof.InFocusRadius=12
	dof.NearIntensity=0.2
	dof.FarIntensity=0.5

	local blur=Instance.new("BlurEffect",Lighting)
	blur.Name="APS_Blur"
	blur.Size=1

	local atmo=Instance.new("Atmosphere",Lighting)
	atmo.Name="APS_Atmos"
	atmo.Density=0.35
	atmo.Offset=0.25
	atmo.Color=Color3.fromRGB(200,220,255)
	atmo.Decay=Color3.fromRGB(120,150,200)
	atmo.Glare=0.3
	atmo.Haze=1

	local sky=Instance.new("Sky",Lighting)
	sky.Name="APS_Sky"
	sky.SkyboxBk="rbxassetid://7018684000"
	sky.SkyboxDn="rbxassetid://7018684000"
	sky.SkyboxFt="rbxassetid://7018684000"
	sky.SkyboxLf="rbxassetid://7018684000"
	sky.SkyboxRt="rbxassetid://7018684000"
	sky.SkyboxUp="rbxassetid://7018684000"
	sky.SunTextureId="rbxassetid://6196665102"
	sky.MoonTextureId="rbxassetid://6444320592"
	sky.StarCount=3000
end

local function removeEffects()
	for _,v in ipairs({"APS_Bloom","APS_Color","APS_SunRays","APS_DOF","APS_Blur","APS_Sky","APS_Atmos"}) do
		local old=Lighting:FindFirstChild(v)
		if old then old:Destroy() end
	end
end

--------------------------------------------------------
-- DRAGGABLE BUTTON FUNCTION
--------------------------------------------------------
local function makeDraggable(btn)
	local dragging, dragInput, dragStart, startPos
	btn.InputBegan:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
			dragging=true
			dragStart=input.Position
			startPos=btn.Position
			input.Changed:Connect(function()
				if input.UserInputState==Enum.UserInputState.End then dragging=false end
			end)
		end
	end)
	btn.InputChanged:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
			dragInput=input
		end
	end)
	game:GetService("UserInputService").InputChanged:Connect(function(input)
		if input==dragInput and dragging then
			local delta=input.Position-dragStart
			btn.Position=UDim2.new(startPos.X.Scale, startPos.X.Offset+delta.X, startPos.Y.Scale, startPos.Y.Offset+delta.Y)
		end
	end)
end

--------------------------------------------------------
-- CREATE GUI
--------------------------------------------------------
local gui=Instance.new("ScreenGui",player:WaitForChild("PlayerGui"))
gui.Name="PerfShaderGUI"
gui.ResetOnSpawn=false

-- Shader Button
local shaderBtn=Instance.new("TextButton",gui)
shaderBtn.Size=UDim2.new(0,120,0,36)
shaderBtn.Position=UDim2.new(0,20,0,100)
shaderBtn.Text="Shader: OFF"
shaderBtn.BackgroundTransparency=0.35
shaderBtn.Font=Enum.Font.SourceSansBold
shaderBtn.TextSize=14

-- Fix Lag Button
local lagBtn=Instance.new("TextButton",gui)
lagBtn.Size=UDim2.new(0,120,0,36)
lagBtn.Position=UDim2.new(0,20,0,150)
lagBtn.Text="Fix Lag: OFF"
lagBtn.BackgroundTransparency=0.35
lagBtn.Font=Enum.Font.SourceSansBold
lagBtn.TextSize=14

makeDraggable(shaderBtn)
makeDraggable(lagBtn)

--------------------------------------------------------
-- BUTTON LOGIC
--------------------------------------------------------
local shaderOn=false
shaderBtn.MouseButton1Click:Connect(function()
	shaderOn=not shaderOn
	if shaderOn then
		setupEffects()
		shaderBtn.Text="Shader: ON"
	else
		removeEffects()
		shaderBtn.Text="Shader: OFF"
	end
end)

local lagOn=false
lagBtn.MouseButton1Click:Connect(function()
	lagOn=not lagOn
	if lagOn then
		PerfUtils.applyLowQuality()
		lagBtn.Text="Fix Lag: ON"
		StarterGui:SetCore("SendNotification",{Title="Fix Lag",Text="Đã bật tối ưu hiệu suất",Duration=3})
	else
		PerfUtils.restoreQuality()
		lagBtn.Text="Fix Lag: OFF"
	end
end)
